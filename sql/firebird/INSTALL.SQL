 -- This program is free software: you can redistribute it and/or modify
-- it under the terms of the GNU General Public License as published by
-- the Free Software Foundation, version 3 of the License.
--
-- This program is distributed in the hope that it will be useful,
-- but WITHOUT ANY WARRANTY; without even the implied warranty of
-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-- GNU General Public License for more details.
--
-- You should have received a copy of the GNU General Public License
-- along with this program. If not, see <http://www.gnu.org/licenses/>.
--
-- Copyright: (C) 2006 jHelpdesk Developers Team
---

--- W tym pliku znajdują się wszystkie definicje obiektów bazy danych
--- potrzebnych do uruchomienia systemu jHelpdesk.

-- DOMENY BAZY

CREATE DOMAIN "BOOLEAN" AS
  CHAR(1) CHARACTER SET ASCII
  DEFAULT 'F' NOT NULL
  CHECK ( VALUE = 'T' OR VALUE = 'F' )
  COLLATE ASCII;

CREATE DOMAIN TICKET_STATUS AS SMALLINT
CHECK(VALUE BETWEEN 1 AND 5);

CREATE DOMAIN comment_type AS SMALLINT
CHECK(VALUE BETWEEN 0 AND 6);

CREATE DOMAIN event_type AS SMALLINT
CHECK(VALUE BETWEEN 1 AND 12);

CREATE DOMAIN USER_ROLE AS SMALLINT
DEFAULT 1 NOT NULL CHECK(VALUE IN(1, 10, 100));

CREATE DOMAIN TICKET_PRIORITY AS SMALLINT
CHECK(VALUE BETWEEN 1 AND 5);

CREATE SEQUENCE USER_ID_SEQ;
ALTER SEQUENCE USER_ID_SEQ RESTART WITH 2;

CREATE TABLE USERS (
  USER_ID INTEGER NOT NULL,
  FIRST_NAME VARCHAR(64) CHARACTER SET UTF8 COLLATE UTF8,
  LAST_NAME VARCHAR(128) CHARACTER SET UTF8 COLLATE UTF8,
  EMAIL VARCHAR(128) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  PASSW VARCHAR(40) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  PHONE VARCHAR(30) CHARACTER SET UTF8 COLLATE UTF8,
  MOBILE VARCHAR(20) CHARACTER SET UTF8 COLLATE UTF8,
  APP_ROLE USER_ROLE NOT NULL,
  IS_ACTIVE "BOOLEAN" NOT NULL,
  CONSTRAINT user_pkey PRIMARY KEY (user_id),
  CONSTRAINT users_email_key UNIQUE (email)
);

CREATE TABLE USER_PREFERENCES (
  ID INTEGER NOT NULL,
  WELCOME_PAGE VARCHAR(128) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  LOCALE VARCHAR(32) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  FILTER_ID INTEGER,
  NEW_TICKET_FORM_VIEW VARCHAR(16) CHARACTER SET UTF8 COLLATE UTF8,
  TICKETS_LIST_SIZE INTEGER DEFAULT 10 NOT NULL,
  ANNOUNCEMENTS_LIST_SIZE INTEGER DEFAULT 10 NOT NULL,
  USERS_LIST_SIZE INTEGER DEFAULT 10 NOT NULL,
  FILTERS_LIST_SIZE INTEGER DEFAULT 10 NOT NULL,
  ARTICLES_LIST_SIZE INTEGER DEFAULT 10 NOT NULL,
  SEARCH_RESULT_LIMIT INTEGER DEFAULT 10 NOT NULL,
  CONSTRAINT USER_PREFERENCES_PKEY PRIMARY KEY (id),
  CONSTRAINT ID_FK FOREIGN KEY(ID) REFERENCES USERS(USER_ID)
);

CREATE SEQUENCE TICKET_CATEGORY_ID_SEQ;
ALTER SEQUENCE TICKET_CATEGORY_ID_SEQ RESTART WITH 2;

CREATE TABLE TICKET_CATEGORY (
  ID INTEGER NOT NULL,
  CATEGORY_NAME VARCHAR(64) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  CATEGORY_DESC VARCHAR(255) CHARACTER SET UTF8 COLLATE UTF8,
  IS_ACTIVE "BOOLEAN" DEFAULT 'T' NOT NULL,
  ORD INTEGER DEFAULT 1 NOT NULL,
  TICKETS_COUNT INTEGER DEFAULT 0 NOT NULL,
  IS_DEFAULT "BOOLEAN" DEFAULT 'F' NOT NULL,
  CONSTRAINT TICKET_CATEGORY_PKEY PRIMARY KEY (id)
);
CREATE INDEX TICKET_CATEGORY_IS_ACTIVE_IDX ON TICKET_CATEGORY COMPUTED BY (IS_ACTIVE);

CREATE SEQUENCE TICKET_ID_SEQ;
ALTER SEQUENCE TICKET_ID_SEQ RESTART WITH 1;

CREATE TABLE TICKET (
  ID INTEGER NOT NULL,
  TICKET_CATEGORY INTEGER NOT NULL,
  PRIORITY TICKET_PRIORITY NOT NULL,
  STATUS TICKET_STATUS NOT NULL,
  SAVIOUR INTEGER,
  NOTIFIER INTEGER NOT NULL,
  INPUTER INTEGER NOT NULL,
  CREATED_AT TIMESTAMP NOT NULL,
  SUBJECT VARCHAR(255) CHARACTER SET UTF8 NOT NULL COLLATE UTF8,
  DESCRIPTION BLOB SUB_TYPE 1 CHARACTER SET UTF8 NOT NULL CHECK (CHAR_LENGTH(DESCRIPTION) <= 8192) COLLATE UTF8,
  STEP_BY_STEP BLOB SUB_TYPE 1 CHARACTER SET UTF8 CHECK (CHAR_LENGTH(STEP_BY_STEP) <= 16834) COLLATE UTF8,
  CONSTRAINT TICKET_PKEY PRIMARY KEY (ID),
  CONSTRAINT TICKET_NOTIFIER_FK FOREIGN KEY (NOTIFIER)
      REFERENCES USERS (USER_ID)
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT TICKET_INPUTER_FK FOREIGN KEY (INPUTER)
      REFERENCES USERS (USER_ID)
      ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT TICKET_TICKET_CATEGORY_FK FOREIGN KEY (TICKET_CATEGORY)
      REFERENCES TICKET_CATEGORY (ID)
      ON UPDATE NO ACTION ON DELETE NO ACTION
);


